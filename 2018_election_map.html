<!DOCTYPE html>
<html>
<head>

<style>
#seldiv { width:380px; position:absolute; top:0px; left:0px; padding:10px; }
#datadiv { width:380px; position:absolute; top:0px; left:0px; padding:10px; overflow:scroll; }
#mapdiv { height:100vh; width:1000px; position:absolute; top:0px; left:380px; }
#races { overflow-y:auto; overflow-x:auto; width:320px; }
.tar { text-align:right; }
body { margin:0px; border:0px; background:whitesmoke; font:10pt Sans-serif; }
h2 { margin:0px; border:0px; font-size:12pt; }
form { font-size:10pt; margin:10px 0px; }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

<script src="2018_voting_precincts.js"></script>
<!--<script src="canvass_Nov2018_general_election_harris.js"></script>//-->
<script src="2018_general_election_results_short.js"></script>

<script>
function fmapresize() {
   md = document.getElementById('mapdiv');
   sd = document.getElementById('seldiv');
   dd = document.getElementById('datadiv');
   md.style.width=(window.innerWidth-sd.offsetWidth)+'px';
   md.style.left=sd.offsetWidth+'px';
   dd.style.height=(window.innerHeight-sd.offsetHeight-20)+'px';
   dd.style.top=sd.offsetHeight+'px'
};
</script>

</head>

<body onresize="fmapresize();">
<div id="seldiv">
<h2>2018 Harris County General Election Results Map (in development)</h2>
<form>
Race: 
<select name="races" id="races" onchange="fracelayer();">
</select><br />
Map Type: 
<select name="maptype" id="maptype" onchange="fracelayer();">
<option value='wbp'>Winner</option>
<option value='sp'>% Straight Party</option>
<option value='pt'>% Turnout</option>
<option value='rv'>Registered Voters</option>
<option value='rvd'>Registered Voters (density)</option>
<option value='bc'>Ballots Cast</option>
<option value='bcd'>Ballots Cast (density)</option>
<option value='bc_r'>Ballots Cast for Republican</option>
<option value='bcd_r'>Ballots Cast for Republican (density)</option>
<option value='bc_d'>Ballots Cast for Democrat</option>
<option value='bcd_d'>Ballots Cast for Democrat (density)</option>
</select><br />
Middle (Tie) Value: 
<select name="midrange" id="midrange" onchange="fracelayer();">
<option value='0.00'>50%</option>
<option value='0.01'>50% &plusmn1%</option>
<option value='0.02'>50% &plusmn2%</option>
<option value='0.03'>50% &plusmn3%</option>
<option value='0.04'>50% &plusmn4%</option>
<option value='0.05'>50% &plusmn5%</option>
<option value='0.10'>50% &plusmn10%</option>
<option value='0.15'>50% &plusmn15%</option>
<option value='0.20'>50% &plusmn20%</option>
<option value='0.25'>50% &plusmn25%</option>
<option value='0.30'>50% &plusmn30%</option>
<option value='0.50'>Gradient (mix)</option>
<option value='-0.50'>Gradient (white)</option>
</select><br />
Show Results Table: <input type="checkbox" name="showresultstable" id="showresultstable"/ >
</form>

</div>
<div id="datadiv"></div>
<div id="mapdiv"></div>

<script>

function faddelem(etype,eparent,eid=null,eclass=null,ehtml=null) {
  var e = document.createElement(etype);
  if (eid) {e.id=eid;};
  if (eclass) {e.className=eclass;};
  if (ehtml) {e.innerHTML=ehtml;};
  eparent.appendChild(e);
  return e;
};

let sqm_per_sqmi = 2589988.1103;

function fdatatable(racedata) {
   var data = document.getElementById('data');
   if (data) { data.remove(); };
   var datadiv = document.getElementById('datadiv');
   data = faddelem('table',datadiv,'data');
   var thead = faddelem('thead',data);
   var hrow = faddelem('tr',thead);
   var tbody = faddelem('tbody',data);
   faddelem('th',hrow,'datahdr_precinct',null,'Precinct');
   var headerdone = false;
   var ch_r = -1;
   var ch_d = -1;
   for (p=0;p<racedata.length;p++) {
      let precinct = racedata[p].properties;
      let er = precinct.election_results;
      if (er) {
         if (fismaptype('wbp')) {
            if (!headerdone) {
               headerdone = true;
               for (c=0;c<er.choices.length;c++) {
                  faddelem('th',hrow,'datahdr_ch'+c,'tar',er.choices[c]);
               };
            };
            var brow = faddelem('tr',tbody);
            faddelem('td',brow,null,null,precinct.PRECINCT);
            for (c=0;c<er.bc.ch.length;c++) {
               faddelem('td',brow,null,'tar',er.bc.ch[c]);
            };
         }
         else if (fismaptypes(['rv','rvd','pt'])) {
            if (!headerdone) {
               headerdone = true;
               faddelem('th',hrow,'datahdr_ch'+c,'tar','% Turnout');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Registered Voters');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Registered Voters per Sq. Mi.');
            };
            var brow = faddelem('tr',tbody);
            faddelem('td',brow,null,null,precinct.PRECINCT);
            faddelem('td',brow,null,'tar',er.pt);
            faddelem('td',brow,null,'tar',er.rv);
            faddelem('td',brow,null,'tar',(fnocomma(er.rv)/precinct.Shapearea*sqm_per_sqmi).toFixed(2));
         }
         else if (fismaptypes(['bc','bcd'])) {
            if (!headerdone) {
               headerdone = true;
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast (Early)');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast (Election Day)');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast (Total)');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast per Sq. Mi.');
            };
            var brow = faddelem('tr',tbody);
            faddelem('td',brow,null,null,precinct.PRECINCT);
            faddelem('td',brow,null,'tar',er.bc.ea);
            faddelem('td',brow,null,'tar',er.bc.ed);
            faddelem('td',brow,null,'tar',er.bc.to);
            faddelem('td',brow,null,'tar',(fnocomma(er.bc.to)/precinct.Shapearea*sqm_per_sqmi).toFixed(2));
         }
         else if (fismaptypes(['bc_r','bcd_r','bc_d','bcd_d'])) {
            if (!headerdone) {
               headerdone = true;
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast (REP)');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast per Sq. Mi. (REP)');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast (DEM)');
               faddelem('th',hrow,'datahdr_ch'+c,'tar','Ballots Cast per Sq. Mi. (DEM)');
               for (c=0;c<er.choices.length;c++) {
                  var choice = er.choices[c].substring(0,3);
                  if (choice==='REP') { ch_r=c; };
                  if (choice==='DEM') { ch_d=c; };
               };
            };
            var brow = faddelem('tr',tbody);
            faddelem('td',brow,null,null,precinct.PRECINCT);
            faddelem('td',brow,null,'tar',(ch_r<0)?'N/A':er.bc.ch[ch_r]);
            faddelem('td',brow,null,'tar',(ch_r<0)?'N/A':(fnocomma(er.bc.ch[ch_r])/precinct.Shapearea*sqm_per_sqmi).toFixed(2));
            faddelem('td',brow,null,'tar',(ch_d<0)?'N/A':er.bc.ch[ch_d]);
            faddelem('td',brow,null,'tar',(ch_d<0)?'N/A':(fnocomma(er.bc.ch[ch_d])/precinct.Shapearea*sqm_per_sqmi).toFixed(2));
         };
      };
   };
};



function fgetaboverange() {
   var midpoint=0.5;
   var range=document.getElementById('midrange').value*1;
   return midpoint+range;
};
function fgetrace() { return document.getElementById('races').value; };
function fgetmaptype() { return document.getElementById('maptype').value; };
function fismaptype(type) { return fgetmaptype()===type; };
function fismaptypes(typeary) { return typeary.includes(fgetmaptype()); };

fmapresize();
function felecresults(pobj,robj,race) {
   for(i=0;i<pobj.length;i++) { delete pobj[i].properties.election_results; }
   for(r=0;r<robj.races.length;r++) {
/*
      if (race.toUpperCase()===robj.races[r].description.toUpperCase()) {
*/
      if (race.toUpperCase()===robj.races[r].de.toUpperCase()) {
         let races = robj.races[r];
/*
         let results = races.results;
*/
         let results = races.re;
         for(p=0;p<results.length;p++) {
            for(y=0;y<pobj.length;y++) {
/*
               if(results[p].precinct===pobj[y].properties.PRECINCT) {
*/
               if(results[p].pr===pobj[y].properties.PRECINCT) {
                  pobj[y].properties['election_results']=results[p];
/*
                  pobj[y].properties.election_results['race']=races.description;
                  pobj[y].properties.election_results['choices']=races.choices;
*/
                  pobj[y].properties.election_results['race']=races.de;
                  pobj[y].properties.election_results['choices']=races.ch;
                  break;
               };
            };
         };
      };
   };
   return pobj;
};

// this is a general function to style polygons (default style)
function polygonstyle(feature) {
   return {
      fillColor: 'darkgray',
      weight: 1,
      opacity: 0.55,
      color: 'darkgray',
      fillOpacity: 0.55,
      smoothFactor: 0.0
   };
};

// this is a general function to add interactive actions (interactions) to the feature polygons:
// 1. popup text on click
// 2. increase polygon opacity and use yellow border when moused over
// 3. reset polygon opacity and border when moused out
function finteract(feature,layer) {
   var popupary = [];
   var popupstr = '';
   let fp = feature.properties;
   if (fp) {
      popupary.push({label:'🏛️'});
      if (fp.PRECINCT) { popupary.push({label:'voting precinct',value:fp.PRECINCT}); };
      var er = fp.election_results;
      if (er) {
/*
         popupary.push({label:'ballots cast',value:er.ballots_cast.total});
         popupary.push({label:'ballots cast (early)',value:er.ballots_cast.early});
         popupary.push({label:'ballots cast (elec day)',value:er.ballots_cast.election_day});
*/
         popupary.push({label:'race',value:er.race});
         popupary.push({label:'🙋'});
         popupary.push({label:'registered voters',value:er.rv});
         popupary.push({label:'percent turnout',value:er.pt});
         popupary.push({label:'🗳️'});
         popupary.push({label:'ballots cast',value:er.bc.to});
         popupary.push({label:'ballots cast (early)',value:er.bc.ea});
         popupary.push({label:'ballots cast (elec day)',value:er.bc.ed});
         popupary.push({label:'☑️'});
/*
         for (c=0;c<er.ballots_cast.choices.length;c++) {
            popupary.push({label:er.choices[c],value:er.ballots_cast.choices[c]});
*/
         for (c=0;c<er.bc.ch.length;c++) {
            popupary.push({label:er.choices[c],value:er.bc.ch[c]});
         };
      };
   };
   for (i=0; i<popupary.length; i++) {
      popupstr += (i>0?'<br />':'')+popupary[i].label+(popupary[i].value?': '+popupary[i].value:'');
   };
   layer.bindPopup(popupstr);
   layer.on('mouseover', function () {
      this.setStyle({
         color: 'yellow',
         fillOpacity: 0.75
      });
   });
   layer.on('mouseout', function () {
      this.setStyle({
         color: 'darkgray',
         fillOpacity: 0.55
      });
   });
/*
   layer.on('click', function () {
   window.location = feature.properties.url;
   });
*/
};

// create main map, and center default view on Harris County
var mainmap = L.map('mapdiv').setView([29.825, -95.435], 10);

// add layers 
// here are some XYZ map tile layers for base maps
var l_stamen_toner = L.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png',{maxZoom:20,attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'});
var l_stamen_toner_lite = L.tileLayer('http://tile.stamen.com/toner-lite/{z}/{x}/{y}.png',{maxZoom:20,attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'}).addTo(mainmap);
var l_stamen_terrain = L.tileLayer('http://tile.stamen.com/terrain/{z}/{x}/{y}.png',{maxZoom:20,attribution:'Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.'});
var l_carto_voyager = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {maxZoom: 20,subdomains: 'abcd',attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>'});
var l_carto_light = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {maxZoom: 20,subdomains: 'abcd',attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>'});
var l_carto_dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}' + (L.Browser.retina ? '@2x.png' : '.png'), {maxZoom: 20,subdomains: 'abcd',attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>, &copy; <a href="https://carto.com/attributions">CARTO</a>'});

var baseMaps = {
    'Stamen Toner':l_stamen_toner,
    'Stamen Toner Lite':l_stamen_toner_lite,
    'Stamen Terrain':l_stamen_terrain,
    'Carto Voyager (non-commercial use only)':l_carto_voyager,
    'Carto Light (non-commercial use only)':l_carto_light,
    'Carto Dark (non-commercial use only)':l_carto_dark,
};
var overlayMaps = {
//    'State':l_state,
//    'County':l_county,
//    'Congressional District':l_cd
//    'Congressional District (by party of rep)':l_cd_rep,
//    'Congressional District (by sex of rep)':l_cd_rep_sex,
//    'Harris County Voting Precinct':l_voting_pct,
//    'Harris County Commissioner Precinct':l_commissioner_pct,
};

var lcontrol = L.control.layers(baseMaps,overlayMaps).addTo(mainmap);
L.control.scale().addTo(mainmap);

var lracelayer;
var lracedata;
function fracelist(divr,races) {
   for (i=0;i<races.length;i++) {
      var n = document.createElement("option");
/*
      n.value = races[i].description;
*/
      n.value = races[i].de;
      n.innerHTML = n.value;
      divr.appendChild(n);
   };
};

function frgb(r,g,b) { return 'rgb('+r+','+g+','+b+')'; };
function fnocomma(str) { return str.replace(/,/g,''); };

function fracelayer(race=null) {
   race = race ? race : fgetrace();
   var aboverange = fgetaboverange();
   lracedata = felecresults(harris_county_voting_precincts.features,election_results,race);
   if (lracelayer) {
      mainmap.removeLayer(lracelayer);
      lcontrol.removeLayer(lracelayer);
   };
   lracelayer = L.geoJSON(harris_county_voting_precincts,{
      attribution:'Harris County Commissioners Court and Harris County Tax Office',
      style: function (feature) {
         let pstyle = polygonstyle(feature);
         let er = feature.properties.election_results;
         var race_nonpartisan = false;
         var race_for_against = false;
         var vote_np = 0; // nonpartisan votes
         var vote_mp = 0; // major party votes
         var vote_r = 0;
         var vote_d = 0;
         var vote_y = 0;
         var vote_n = 0;
         var vote_total = 0;
         var pctturnout = 0;
         var regvoters = 0;
         var rvdensity = 0;
         var ballotscast = 0; // might differ from vote_total if there are write-in candidates
         var bcdensity = 0;
         var bcdensity_r = 0;
         var bcdensity_d = 0;
         let pareami = feature.properties.Shapearea/sqm_per_sqmi;

         if (er) {
/*
            for (c=0;c<er.ballots_cast.choices.length;c++) {
               var choice = er.choices[c].substring(0,3);
               var votes = fnocomma(er.ballots_cast.choices[c])*1;
*/
            for (c=0;c<er.bc.ch.length;c++) {
               var choice = er.choices[c].substring(0,3);
               var votes = fnocomma(er.bc.ch[c])*1;
               if (['FOR','YES'].includes(choice)) {vote_y = votes}
               else if (['AGA','NO'].includes(choice)) {vote_n = votes}
               else if (choice==='REP') {vote_r = votes}
               else if (choice==='DEM') {vote_d = votes}
               else if (['IND','LIB'].includes(choice)) {}
               else { vote_np+=1 };
               vote_total += votes;
            };
            if (fismaptype('pt')) {pctturnout=er.pt.replace('%','')/100;} 
            else if (fismaptype('rv')) {regvoters=fnocomma(er.rv)*1;}
            else if (fismaptype('rvd')) {rvdensity=fnocomma(er.rv)/pareami;}
            else if (fismaptype('bc')) {ballotscast=fnocomma(er.bc.to);}
            else if (fismaptype('bcd')) {bcdensity=fnocomma(er.bc.to)/pareami;} 
            else if (fismaptype('bcd_r')) {bcdensity_r=vote_r/pareami;} 
            else if (fismaptype('bcd_d')) {bcdensity_d=vote_d/pareami;}

            vote_mp = vote_r+vote_d;
/*
            race_nonpartisan = vote_np===er.ballots_cast.choices.length;
*/
            race_nonpartisan = vote_np===er.bc.ch.length;
            race_for_against = vote_y+vote_n>0;
         };
         pstyle.fillColor = !er ? 'none'
            :fismaptype('rv')?(regvoters===0?'darkgray':frgb( (regvoters/7500*255) , (regvoters/7500*255) , ((1-(regvoters/7500))*64) ))
            :fismaptype('rvd')?(rvdensity===0?'darkgray':frgb( (rvdensity/750*255) , (rvdensity/750*255) , ((1-(rvdensity/750))*64) ))
            :vote_total===0?'darkgray'
//            :fismaptype('pt')?frgb( pctturnout*255 , pctturnout*255 , 0 )
            :fismaptype('pt')?frgb( (pctturnout<0.5?0:((pctturnout-0.5)/0.5*255)) , pctturnout*255 , (pctturnout<0.5?((pctturnout)/0.5*255):((1-pctturnout)/0.5*255)) )
            :fismaptype('bc')?frgb( (ballotscast/4000*255) , ((1-(ballotscast/4000))*64) , (ballotscast/4000*255) )
            :fismaptype('bcd')?frgb( (bcdensity/400*255) , ((1-(bcdensity/400))*64) , +(bcdensity/400*255) )
            :fismaptype('bc_r')?(race_for_against||race_nonpartisan?'darkgray':frgb( +(vote_r/1500*255) , ((1-(vote_r/1500))*64) , ((1-(vote_r/1500))*64) )) 
            :fismaptype('bcd_r')?(race_for_against||race_nonpartisan?'darkgray':frgb( (bcdensity_r/150*255) , ((1-(bcdensity_r/150))*64) , ((1-(bcdensity_r/150))*64) )) 
            :fismaptype('bc_d')?(race_for_against||race_nonpartisan?'darkgray':frgb( ((1-(vote_d/1500))*64) , ((1-(vote_d/1500))*64) , (vote_d/1500*255) )) 
            :fismaptype('bcd_d')?(race_for_against||race_nonpartisan?'darkgray':frgb( ((1-(bcdensity_d/150))*64) , ((1-(bcdensity_d/150))*64) , (bcdensity_d/150*255) )) 
            :fismaptype('sp')?'darkgray' // unhandled
            //fismaptype('wbp') from this point
            :race_nonpartisan?'orange'
            :(race_for_against&&aboverange>=1.0)?frgb( (vote_n/vote_total>0.5?255:(vote_n/vote_total*2*255)) , (vote_y/vote_total>0.5?255:(vote_y/vote_total*2*255)) , 0 )
            :(race_for_against&&aboverange<=0.0)?frgb( (vote_n/vote_total>0.5?255:(vote_n/vote_total*2*255)) , (vote_y/vote_total>0.5?255:(vote_y/vote_total*2*255)) , (vote_y/vote_total>0.5?(vote_n/vote_total*2*255):(vote_y/vote_total*2*255)) )
            :vote_y/vote_total>aboverange?'green'
            :vote_n/vote_total>aboverange?'red'
            :race_for_against?'yellow'
            :vote_total-vote_mp>vote_mp?'goldenrod'
            :aboverange>=1.0?'rgb('+vote_r/vote_mp*255+',0,'+vote_d/vote_mp*255+')'
            :aboverange<=0.0?'rgb('+(vote_r/vote_mp>0.5?255:(vote_r/vote_mp*2*255))+','+(vote_d/vote_mp>0.5?(vote_r/vote_mp*2*255):(vote_d/vote_mp*2*255))+','+(vote_d/vote_mp>0.5?255:(vote_d/vote_mp*2*255))+')'
            :vote_r/vote_mp>aboverange?'red'
            :vote_d/vote_mp>aboverange?'blue'
            :'purple';
         return pstyle;
      },
      onEachFeature:finteract
   });
   lracelayer.addTo(mainmap);
   fdatatable(lracedata);
};


fracelist(document.getElementById("races"),election_results.races);
fracelayer();
</script>

</body>
</html>